# ä¾¦å¬åœ°å€, ipv6 ä½¿ç”¨ [::]:9394
grpc_addr = "0.0.0.0:9394"
http_addr = "0.0.0.0:8080"
# é»˜è®¤30sæ— ä¸ŠæŠ¥åˆ¤å®šä¸‹çº¿
offline_threshold = 30

# ç®¡ç†å‘˜è´¦å·,ä¸è®¾ç½®é»˜è®¤éšæœºç”Ÿæˆï¼Œç”¨äºæŸ¥çœ‹ /detail, /map
jwt_secret = "" # ä¿®æ”¹è¿™ä¸ª, ä½¿ç”¨ openssl rand -base64 16 ç”Ÿæˆ secret
admin_user = ""
admin_pass = ""

# hosts è·Ÿ hosts_group ä¸¤ç§é…ç½®æ¨¡å¼ä»»æŒ‘ä¸€ç§é…ç½®å³å¯
# name ä¸»æœºå”¯ä¸€æ ‡è¯†ï¼Œä¸å¯é‡å¤ï¼Œalias ä¸ºå±•ç¤ºå
# notify = false å•ç‹¬ç¦æ­¢å•å°æœºå™¨çš„å‘Šè­¦ï¼Œä¸€èˆ¬é’ˆå¯¹ç½‘ç»œå·®ï¼Œé¢‘ç¹ä¸Šä¸‹çº¿
# monthstart = 1 æ²¡å¯ç”¨vnstatæ—¶ï¼Œè¡¨ç¤ºæœˆæµé‡ä»æ¯æœˆå“ªå¤©å¼€å§‹ç»Ÿè®¡
# disabled = true å•æœºç¦ç”¨
# location æ”¯æŒå›½æ—— emoji https://emojixd.com/group/flags
# æˆ–å›½å®¶ç¼©å†™ï¼Œå¦‚ cn us ç­‰ç­‰ï¼Œæ‰€æœ‰å›½å®¶è§ç›®å½• web/static/flags
# è‡ªå®šä¹‰æ ‡ç­¾ labels = "os=centos;ndd=2022/11/25;spec=2C/4G/60G;"
# os æ ‡ç­¾å¯é€‰ï¼Œä¸å¡«åˆ™ä½¿ç”¨ä¸ŠæŠ¥æ•°æ®ï¼Œndd(next due date) ä¸‹æ¬¡ç»­è´¹æ—¶é—´, spec ä¸ºä¸»æœºè§„æ ¼
# os å¯ç”¨å€¼ centos debian ubuntu alpine pi arch windows linux macos android
hosts = [
  {name = "h1", password = "p1", alias = "n1", location = "ğŸ ", type = "kvm", labels = "os=arch;ndd=2022/11/25;spec=2C/4G/60G;"},
  {name = "h2", password = "p2", alias = "n2", location = "ğŸ¢", type = "kvm", disabled = false},
  {name = "h3", password = "p3", alias = "n3", location = "ğŸ¡", type = "kvm", monthstart = 1},
  {name = "h4", password = "p4", alias = "n4", location = "cn", type = "kvm", notify = true, labels = "ndd=2022/11/25;spec=2C/4G/60G;"},

  # æœ€å°åŒ–é…ç½®
  {name = "mac", password = "pp", alias = "macos"},
  {name = "pi", password = "pp", alias = "pi", labels = "os=pi"},
  {name = "win", password = "pp", alias = "windows"},
  {name = "android", password = "pp", alias = "android", labels = "os=android"},
]

# åŠ¨æ€æ³¨å†Œæ¨¡å¼ï¼Œä¸å†éœ€è¦é’ˆå¯¹æ¯ä¸€ä¸ªä¸»æœºåšå•ç‹¬é…ç½®
# gid ä¸ºæ¨¡æ¿ç»„id, è‡ªåŠ¨æ³¨å†Œå”¯ä¸€æ ‡è¯†ï¼Œä¸å¯é‡å¤
hosts_group = [
  # å¯ä»¥æŒ‰å›½å®¶åœ°åŒºæˆ–ç”¨é€”æ¥åšåˆ†ç»„
  {gid = "g1", password = "pp", location = "ğŸ ", type = "kvm", labels = "os=centos;ndd=2022/11/25;spec=2C/4G/60G;"},
  {gid = "g2", password = "pp", location = "ğŸ¢", type = "kvm", notify = true},
  # ä¾‹å¦‚ä¸å‘é€é€šçŸ¥å¯ä»¥å•ç‹¬åšä¸€ç»„
  {gid = "silent", password = "pp", location = "ğŸ¡", type = "kvm", notify = false},
]
# åŠ¨æ€æ³¨å†Œæ¨¡å¼ä¸‹ï¼Œæ— æ•ˆæ•°æ®æ¸…ç†é—´éš”ï¼Œé»˜è®¤ 30s
group_gc = 30

# !!! ä¸€é”®éƒ¨ç½²å¦‚æœæ²¡é—®é¢˜åˆ™ä¸éœ€è¦åŠ¨ï¼ŒServer ä¼šè‡ªè¡Œæ ¹æ®ä½ çš„åŸŸåç”Ÿæˆ server_url
# ä¿®æ­£ä¸€é”®éƒ¨ç½²ï¼Œè¯·è‡ªè¡Œæ›¿æ¢ ssr.rs ä¸ºä½ çš„åŸŸå,
# server_url = "https://ssr.rs/report"
# stat_client é»˜è®¤å®‰è£…çš„è·¯å¾„
workspace = "/opt/ServerStatus"

# ä¸å¼€å¯å‘Šè­¦ï¼Œå¯å¿½ç•¥åé¢é…ç½®ï¼Œæˆ–è€…åˆ é™¤ä¸éœ€çš„é€šçŸ¥æ–¹å¼
# å‘Šè­¦é—´éš”é»˜è®¤ä¸º30s
notify_interval = 30
# https://core.telegram.org/bots/api
# https://jinja.palletsprojects.com/en/3.0.x/templates/#if
[tgbot]
# å¼€å…³ true æ‰“å¼€
enabled = false
bot_token = "<tg bot token>"
chat_id = "<chat id>"
# host å¯ç”¨å­—æ®µè§ payload.rs æ–‡ä»¶ HostStat ç»“æ„, {{host.xxx}} ä¸ºå ä½å˜é‡
# ä¾‹å¦‚ host.name å¯æ›¿æ¢ä¸º host.aliasï¼Œå¤§å®¶æ ¹æ®è‡ªå·±çš„å–œå¥½æ¥ç¼–å†™é€šçŸ¥æ¶ˆæ¯
# {{ip_info.query}} ä¸»æœº ip, {{sys_info.host_name}} ä¸»æœº hostnameï¼Œè§ server_status.proto
title = "â—<b>Server Status</b>"
online_tpl =  "{{config.title}} \nğŸ˜† {{host.location}} {{host.name}} ä¸»æœºæ¢å¤ä¸Šçº¿å•¦"
offline_tpl = "{{config.title}} \nğŸ˜± {{host.location}} {{host.name}} ä¸»æœºå·²ç»æ‰çº¿å•¦"
# custom æ¨¡æ¿ç½®ç©ºåˆ™åœç”¨è‡ªå®šä¹‰å‘Šè­¦ï¼Œåªä¿ç•™ä¸Šä¸‹çº¿é€šçŸ¥
custom_tpl = """
{% if host.memory_used / host.memory_total > 0.5  %}
<pre>ğŸ˜² {{host.name}} ä¸»æœºå†…å­˜ä½¿ç”¨ç‡è¶…50%, å½“å‰{{ (100 * host.memory_used / host.memory_total) | round }}%  </pre>
{% endif %}

{% if host.hdd_used / host.hdd_total  > 0.5  %}
<pre>ğŸ˜² {{host.name}} ä¸»æœºç¡¬ç›˜ä½¿ç”¨ç‡è¶…50%, å½“å‰{{ (100 * host.hdd_used / host.hdd_total) | round }}% </pre>
{% endif %}
"""
###################### tgbot end ##########################

## å¯é€‰ å•çº¯è®°å½• event åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œè°ƒè¯•è‡ªå®šä¹‰å‘Šè­¦ä½¿ç”¨
[log]
enabled = false
log_dir = "/opt/ServerStatus/logs"
tpl = """{% set obj = dict(event=event, host=host, ip_info=ip_info, sys_info=sys_info) %} {{ obj | tojson}}"""

###################### log end ##########################

## å¯é€‰ å¾®ä¿¡é€šçŸ¥
[wechat]
enabled = false
corp_id = "<corp id>"
corp_secret = "<corp secret>"
agent_id = "<agent id>"
title = "â—Server Status"
online_tpl  = "{{config.title}} \nğŸ˜† {{host.location}} çš„ {{host.name}} ä¸»æœºæ¢å¤ä¸Šçº¿å•¦"
offline_tpl = "{{config.title}} \nğŸ˜± {{host.location}} çš„ {{host.name}} ä¸»æœºå·²ç»æ‰çº¿å•¦"
custom_tpl = """
{% if host.memory_used / host.memory_total > 0.8  %}
ğŸ˜² {{host.name}} ä¸»æœºå†…å­˜ä½¿ç”¨ç‡è¶…80%
{% endif %}

{% if host.hdd_used / host.hdd_total > 0.8  %}
ğŸ˜² {{host.name}} ä¸»æœºç¡¬ç›˜ä½¿ç”¨ç‡è¶…80%
{% endif %}
"""
###################### wechat end ##########################

## å¯é€‰ é‚®ä»¶é€šçŸ¥
[email]
enabled = false
server = "smtp.gmail.com"
username = "user@email.com"
password = "***"
to = "user1@email.com;user2@email.com"
subject = "ServerStatus Notification"
title = "â—<b>Server Status</b><br/>"
online_tpl  = "{{config.title}} ğŸ˜† {{host.location}} çš„ {{host.name}} ä¸»æœºæ¢å¤ä¸Šçº¿å•¦"
offline_tpl = "{{config.title}} ğŸ˜± {{host.location}} çš„ {{host.name}} ä¸»æœºå·²ç»æ‰çº¿å•¦"
custom_tpl = """
{% if host.memory_used / host.memory_total > 0.8  %}
<pre>ğŸ˜² {{host.name}} ä¸»æœºå†…å­˜ä½¿ç”¨ç‡è¶…80%, å½“å‰{{ (100 * host.memory_used / host.memory_total) | round }}%  </pre>
{% endif %}

{% if host.hdd_used / host.hdd_total > 0.8  %}
<pre>ğŸ˜² {{host.name}} ä¸»æœºç¡¬ç›˜ä½¿ç”¨ç‡è¶…80%, å½“å‰{{ (100 * host.hdd_used / host.hdd_total) | round }}% </pre>
{% endif %}
"""

###################### email end ##########################

## å¯é€‰ webhook
# ç†è®ºä¸Šæ”¯æŒæ‰€æœ‰æ”¯æŒ webhook çš„è½¯ä»¶ï¼Œå¦‚ Discordã€ Slackã€ é£ä¹¦ã€ ä¼ä¸šç‰ˆå¾®ä¿¡(WorkWechat)ã€ é’‰é’‰(DingTalk)ç­‰ã€‚
# webhook è°ƒç”¨åŸºæœ¬ä¸Šéƒ½å·®ä¸å¤šï¼Œå·®å¼‚åªåœ¨æœ€åè¿”å›çš„ json ç»“æ„ï¼Œæ ¹æ®å„è‡ªçš„ api æ–‡æ¡£è‡ªè¡Œæ„å»ºç›¸åº”çš„ json ç»“æ„å³å¯ã€‚
# script ä½¿ç”¨è„šæœ¬å¼•æ“ https://rhai.rs/book/
[webhook]
# æ€»å¼€å…³
enabled = false
  # å¯å¤šä¸ª webhook.receiver
  [[webhook.receiver]] # é€šç”¨å‹ webhook
  # å±€éƒ¨å¼€å…³
  enabled = false
  # https://webhook.site/#!/2b1ad731-45fe-49a8-ae91-614167019db2
  url = "https://webhook.site/2b1ad731-45fe-49a8-ae91-614167019db2"
  headers = { content-type = "application/json", x-data = "y-data" }
  # headers = { content-type = "text/plain" }
  # å¯é€‰ HTTP Basic Auth
  username = "u"
  password = "p"
  timeout = 5 #s
  # ç®€å•å‘é€ä¸€ä¸ª json å¯¹è±¡ï¼Œ#{} ä¸º Object å¯¹è±¡, [] ä¸ºæ•°ç»„
  # æœ€ç»ˆç»“æœ, å›ºå®šç»“æ„ [æ˜¯å¦å‘é€é€šçŸ¥ï¼Œç»“æœå¯¹è±¡]
  script = """[true, #{config: config, event: event, host: host, ip_info: ip_info, sys_info:sys_info} ]"""

  [[webhook.receiver]] # Discord
  enabled = false
  # https://discord.com/developers/docs/resources/webhook
  url = "https://discord.com/api/webhooks/xxxxxxxxxxxxxxxxxxxxxxx"
  headers = { content-type = "application/json" }
  timeout = 5 #s
  script = """
    let message = "";
    switch event {
      "Custom" => {      // è‡ªå®šä¹‰äº‹ä»¶
          let threshold = 10;
          let msgs = [];
          let memory_usage = round(host.memory_used * 100.0 / host.memory_total);
          if memory_usage > threshold {
             msgs.push(`ğŸ˜² ${host.location} ${host.name} ä¸»æœºå†…å­˜ä½¿ç”¨ç‡è¶…${threshold}%, å½“å‰ ${memory_usage}%`);
          }
          let hdd_usage = round(host.hdd_used * 100.0 / host.hdd_total);
          if hdd_usage > threshold {
              msgs.push(`ğŸ˜² ${host.location} ${host.name} ä¸»æœºç¡¬ç›˜ä½¿ç”¨ç‡è¶…${threshold}%, å½“å‰ ${hdd_usage}%`);
          }
          message = join(msgs, "\\n");
      },
      "NodeDown" => {   // æ‰çº¿
          message = `ğŸ˜± ${host.location} ${host.name} ä¸»æœºå·²ç»æ‰çº¿å•¦`;
      },
      "NodeUp" => {     // ä¸Šçº¿
          message = `ğŸ˜† ${host.location} ${host.name} ä¸»æœºæ¢å¤ä¸Šçº¿å•¦`;
      }
    }

    // è¿”å›çš„ json ç»“æ„ï¼Œ#{} ä¸º Object å¯¹è±¡, [] ä¸ºæ•°ç»„
    // æœ€ç»ˆç»“æœ, å›ºå®šç»“æ„ [æ˜¯å¦å‘é€é€šçŸ¥ï¼Œç»“æœå¯¹è±¡]
    [message.len() > 0, #{ embeds: [ #{
      title: ":bell: ServerStatus-Rust :bell:",
      fields: [
        #{ name: "Event", value: event, },
        #{ name: "Datetime", value: now_str(), },
        #{ name: "Message", value: message, },
      ]
    }]}]
  """

  [[webhook.receiver]] # Slack
  enabled = false
  # https://api.slack.com/messaging/webhooks
  url = "https://hooks.slack.com/services/xxxxxxxxxxxxxxxxxxxxxxx"
  headers = { content-type = "application/json" }
  timeout = 5 #s
  script = """
    let message = "";
    switch event {
      "Custom" => {      // è‡ªå®šä¹‰äº‹ä»¶
          let threshold = 80;
          let msgs = [];
          let memory_usage = round(host.memory_used * 100.0 / host.memory_total);
          if memory_usage > threshold {
             msgs.push(`ğŸ˜² ${host.location} ${host.name} ä¸»æœºå†…å­˜ä½¿ç”¨ç‡è¶…${threshold}%, å½“å‰ ${memory_usage}%`);
          }
          let hdd_usage = round(host.hdd_used * 100.0 / host.hdd_total);
          if hdd_usage > threshold {
              msgs.push(`ğŸ˜² ${host.location} ${host.name} ä¸»æœºç¡¬ç›˜ä½¿ç”¨ç‡è¶…${threshold}%, å½“å‰ ${hdd_usage}%`);
          }
          message = join(msgs, "\\n");
      },
      "NodeDown" => {   // æ‰çº¿
          message = `ğŸ˜± ${host.location} ${host.name} ä¸»æœºå·²ç»æ‰çº¿å•¦`;
      },
      "NodeUp" => {     // ä¸Šçº¿
          message = `ğŸ˜† ${host.location} ${host.name} ä¸»æœºæ¢å¤ä¸Šçº¿å•¦`;
      }
    }

    // æœ€ç»ˆç»“æœ, å›ºå®šç»“æ„ [æ˜¯å¦å‘é€é€šçŸ¥ï¼Œç»“æœå¯¹è±¡]
    [message.len() > 0, #{text: message}]
  """

  [[webhook.receiver]] # WorkWechat
  enabled = false
  # https://developer.work.weixin.qq.com/document/path/91770
  url = "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxxxxxxxxxxxxxxxxxxxx"
  headers = { content-type = "application/json" }
  timeout = 5 #s
  script = """
    let message = "";
    switch event {
      "Custom" => {      // è‡ªå®šä¹‰äº‹ä»¶
          let threshold = 80;
          let msgs = [];
          let memory_usage = round(host.memory_used * 100.0 / host.memory_total);
          if memory_usage > threshold {
             msgs.push(`ğŸ˜² ${host.location} ${host.name} ä¸»æœºå†…å­˜ä½¿ç”¨ç‡è¶…${threshold}%, å½“å‰ ${memory_usage}%`);
          }
          let hdd_usage = round(host.hdd_used * 100.0 / host.hdd_total);
          if hdd_usage > threshold {
              msgs.push(`ğŸ˜² ${host.location} ${host.name} ä¸»æœºç¡¬ç›˜ä½¿ç”¨ç‡è¶…${threshold}%, å½“å‰ ${hdd_usage}%`);
          }
          message = join(msgs, "\\n");
      },
      "NodeDown" => {   // æ‰çº¿
          message = `ğŸ˜± ${host.location} ${host.name} ä¸»æœºå·²ç»æ‰çº¿å•¦`;
      },
      "NodeUp" => {     // ä¸Šçº¿
          message = `ğŸ˜† ${host.location} ${host.name} ä¸»æœºæ¢å¤ä¸Šçº¿å•¦`;
      }
    }

    // æœ€ç»ˆç»“æœ, å›ºå®šç»“æ„ [æ˜¯å¦å‘é€é€šçŸ¥ï¼Œç»“æœå¯¹è±¡]
    [message.len() > 0, #{
      msgtype: "text",
      text: #{
        content: message
      }
    }]
  """

  [[webhook.receiver]] # Bark
  enabled = false
  # https://github.com/Finb/Bark
  # https://day.app/2021/06/barkfaq/
  url = "https://api.day.app/push"
  headers = { content-type = "application/json; charset=utf-8" }
  timeout = 5 #s
  script = """
    let message = "";
    switch event {
      "Custom" => {      // è‡ªå®šä¹‰äº‹ä»¶
          // ä½¿ç”¨ç‡é˜ˆå€¼ï¼Œè¿™é‡Œæ˜¯ç£ç›˜ è¶… 70% å‘Šè­¦
          let threshold = 70;
          let msgs = [];
          let memory_usage = round(host.memory_used * 100.0 / host.memory_total);
          if memory_usage > threshold {
             msgs.push(`ğŸ˜² ${host.location} ${host.name} ä¸»æœºå†…å­˜ä½¿ç”¨ç‡è¶…${threshold}%, å½“å‰ ${memory_usage}%`);
          }
          let hdd_usage = round(host.hdd_used * 100.0 / host.hdd_total);
          if hdd_usage > threshold {
              msgs.push(`ğŸ˜² ${host.location} ${host.name} ä¸»æœºç¡¬ç›˜ä½¿ç”¨ç‡è¶…${threshold}%, å½“å‰ ${hdd_usage}%`);
          }
          message = join(msgs, "\\n");
      },
      "NodeDown" => {   // æ‰çº¿
          message = `ğŸ˜± ${host.location} ${host.name} ä¸»æœºå·²ç»æ‰çº¿å•¦`;
      },
      "NodeUp" => {     // ä¸Šçº¿
          message = `ğŸ˜† ${host.location} ${host.name} ä¸»æœºæ¢å¤ä¸Šçº¿å•¦`;
      }
    }

    // æœ€ç»ˆç»“æœ, å›ºå®šç»“æ„ [æ˜¯å¦å‘é€é€šçŸ¥ï¼Œç»“æœå¯¹è±¡]
    [message.len() > 0, #{
      // æ ‡é¢˜
      title: "ServerStatusRust",
      // å‘Šè­¦å†…å®¹
      body: message,
      // ä¿®æ”¹æˆä½ çš„è®¾å¤‡ key, app å†…è·å–
      device_key: "fLLBrV****kM5H",
      // åé¢ä¸ºå¯é€‰å­—æ®µå‚è€ƒ https://github.com/Finb/bark-server/blob/master/docs/API_V2.md
      // å…¶å®ƒè§’æ ‡, é“ƒå£°, icon, å‚è€ƒ app é‡Œé¢çš„è¯´æ˜å³å¯
      badge: 1,
      sound: "minuet.caf",
      icon: "https://day.app/assets/images/avatar.jpg",
      group: "SSR",
      url: "https://github.com/zdz/ServerStatus-Rust"

    }]
  """

###################### webhook end ##########################
